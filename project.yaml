version: '3.0'

expectations:
  population_size: 5000

actions:
# Contemporary comparison data management:
# # Before matching data management:
  generate_long_covid_exposure_dataset:
    run: 
      databuilder:v0 generate-dataset
        analysis/dataset_definition_unmatched_exp_lc.py
        --output output/dataset_exp_lc_unmatched.csv
    outputs:
      highly_sensitive:
        cohort: output/dataset_exp_lc_unmatched.csv

  generate_list_gp_use_long_covid_dx:
    run: 
      databuilder:v0 generate-dataset
        analysis/dataset_definition_lc_gp_list.py
        --output output/dataset_lc_gp_list.csv
    outputs:
      highly_sensitive:
        cohort: output/dataset_lc_gp_list.csv

  generate_dataset_comparator_exclude_gp_no_long_covid:
    needs: [generate_list_gp_use_long_covid_dx]
    run: 
      databuilder:v0 generate-dataset
        analysis/dataset_definition_unmatched_comparator.py
        --output output/dataset_comparator_unmatched.csv
    outputs:
      highly_sensitive:
        cohort: output/dataset_comparator_unmatched.csv
        
# # # QC step:         
  qc_01examine_unmatched_data:
    needs: [generate_dataset_comparator_exclude_gp_no_long_covid, generate_long_covid_exposure_dataset]  
    run: 
      r:latest analysis/qc01_unmatched_control.R
    outputs:
      moderately_sensitive:
        cohort: output/qc01_check_unmatched.csv
        
# # OS matching
  test_matching:
    run:
      python:latest python analysis/match_test.py
    needs: [generate_dataset_comparator_exclude_gp_no_long_covid, generate_long_covid_exposure_dataset]
    outputs: 
      highly_sensitive:
        matched_cases: output/matched_cases_stp.csv
        matched_matches: output/matched_matches_stp.csv
        matched_all: output/matched_combined_stp.csv
      moderately_sensitive: 
        matching_report: output/matching_report_stp.txt
# # After matching data management
  import_matched_exposure:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_cases.py
        --output output/matched_cases_with_ehr.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_cases_with_ehr.csv.gz

  import_matched_controls:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_control.py
        --output output/matched_control_with_ehr.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_control_with_ehr.csv.gz


  import_matched_exposure_drug_cost:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_cases_drug_costs.py
        --output output/matched_cases_with_drug_costs.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_cases_with_drug_costs.csv.gz

  import_matched_controls_drug_costs:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_control_drug_costs.py
        --output output/matched_control_with_drug_costs.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_control_with_drug_costs.csv.gz

# # After matching data management: for new version of data
  import_matched_exposure_update:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_cases_updated.py
        --output output/matched_cases_with_ehr_update.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_cases_with_ehr_update.csv.gz

  import_matched_control_updates:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_control_updated.py
        --output output/matched_control_with_ehr_update.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_control_with_ehr_update.csv.gz

# Historical comparison data management:
# # Before matching data management:
  generate_historical_exp_data:
    run: 
      databuilder:v0 generate-dataset analysis/dataset_definition_hx_unmatched_exp_lc.py
        --output output/hx_unmatched_exp.csv
    outputs:
      highly_sensitive:
        hx_cohort: output/hx_unmatched_exp.csv
  
  generate_historical_comp_data_exclude_gp_no_long_covid:
    needs: [generate_list_gp_use_long_covid_dx]
    run: 
      databuilder:v0 generate-dataset analysis/dataset_definition_hx_unmatched_com_no_lc.py
        --output output/hx_dataset_comp_unmatched.csv
    outputs:
      highly_sensitive:
        hx_cohort: output/hx_dataset_comp_unmatched.csv
        
# # # QC step:         
  qc_02examine_historical_unmatched_data:
    needs: [generate_historical_exp_data, generate_historical_comp_data_exclude_gp_no_long_covid]  
    run: 
      r:latest analysis/qc02_hx_unmatched_check.R
    outputs:
      moderately_sensitive:
        cohort: output/qc02_hx_check_unmatched.csv
        
# # OS matching
  historical_matching:
    run:
      python:latest python analysis/match_historical.py
    needs: [generate_historical_exp_data, generate_historical_comp_data_exclude_gp_no_long_covid]
    outputs: 
      highly_sensitive:
        matched_cases: output/matched_cases_historical.csv
        matched_matches: output/matched_matches_historical.csv
        matched_all: output/matched_combined_historical.csv
      moderately_sensitive: 
        matching_report: output/matching_report_historical.txt

# # After matching data management
  import_matched_historical_exposure:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_hx_matched_exp_lc.py
        --output output/hx_matched_cases_with_ehr.csv.gz
    needs: [historical_matching]
    outputs: 
      highly_sensitive:
        cohort: output/hx_matched_cases_with_ehr.csv.gz

  import_matched_historical_controls:
    run: >
       databuilder:v0
        generate-dataset analysis/dataset_definition_hx_matched_comp.py
        --output output/hx_matched_control_with_ehr.csv.gz
    needs: [historical_matching]
    outputs: 
      highly_sensitive:
        cohort: output/hx_matched_control_with_ehr.csv.gz

# Reporting: demographic distribution 

# Contemporary comparison: 
  report01_matched_datasets:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st01_report_matched.R
    outputs: 
      moderately_sensitive: 
        matched_table: output/st01_matched_numbers_table.csv  # Table 1
        explore_fu_time: output/st01_matched_numbers_check_fu.csv # check the incorrect follow-up time
        explore_vax_fig: output/st1_exporing_vax_index_date.png # Check vax date
        missing_table: output/missing_distribution_table.csv # Missing pattern tab
        missing_pattern: output/missing_pattern_current.png # Missing patter plot


# Check follow-up time 
  qc_03_check_na:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/qc03_now_check_followup.R
    outputs: 
      moderately_sensitive: 
        check_na_in_data: output/st02_check_min.csv

# Contemporary comparison

# Two part hurdle model:
# # All healthcare utilisation 

  report_03_hurdle_01_all_visits:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st03_01_model_curr_nb_hurdel.R
    outputs: 
      moderately_sensitive:
        total_reg_summary: output/st03_01_total_reg_summary.txt
        binomial_visits: output/st03_01_total_binomial.csv
        hurdle_all_visits: output/st03_01_total_hurdle.csv
        predicted_visits: output/st03_01_total_predicted_counts.csv
        total_visit_bi_model_count: output/st03_01_total_binomial_model_counts.csv
        total_visit_hurdle_count: output/st03_01_total_gamma_model_counts.csv

# # GP utilisation  - hurdle

  report_03_hurdle_02_gp_visits:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st03_02_model06_gp_hurdel.R
    outputs: 
      moderately_sensitive: 
        gp_reg_summary: output/st03_02_gp_reg_summary.txt
        gp_binomial: output/st03_02_gp_binomial.csv
        gp_hurdle: output/st03_02_gp_hurdle.csv
        predicted_gp_visits: output/st03_02_gp_predicted_counts.csv
        gp_visit_bi_model_count: output/st03_02_gp_binomial_model_counts.csv
        gp_visit_hurdle_model_count: output/st03_02_gp_hurdle_model_counts.csv

# # Hospital admission - hurdle

  report_03_hurdle_03_hospital_admin:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st03_03_model07_hos_hurdel.R
    outputs: 
      moderately_sensitive: 
        hos_binomial: output/st03_03_hos_binomial.csv
        hos_hurdle: output/st03_03_hos_hurdle.csv
        hos_reg_summary: output/hos_reg_summary.txt
        predicted_hos_admin_counts: output/st03_03_hos_predicted_counts.csv
        hos_visit_bi_model_count: output/st03_03_hos_binomial_model_counts.csv
        hos_visit_hurdle_model_count: output/st03_03_hos_hurdle_model_counts.csv
        
# # QC 05: check hospital admission distribution:

  qc_05_h_hospital_admin:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/qc05_check_hos_distribution_models.R
    outputs: 
      moderately_sensitive: 
        hos_distribution: output/qc05_hos_distribution_compare.png
        hos_overdispersion: output/qc05_hos_vist_overdispersion_test.csv
        hos_model_comparison: output/qc05_hos_vist_model_compare.csv
        
# # A&E visits - hurdle
        
  report_03_hurdle_04_ane_visits:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st03_04_model08_ane_hurdel.R
    outputs: 
      moderately_sensitive: 
        ane_binomial: output/st03_04_ane_binomial.csv
        ane_hurdle: output/st03_04_ane_hurdle.csv
        ane_reg_summary: output/ane_reg_summary.txt
        predicted_ane_visits: output/st03_04_ane_predicted_counts.csv
        ane_visit_bi_model_count: output/st03_04_ane_binomial_model_counts.csv
        ane_visit_hurdle_model_count: output/st03_04_ane_hurdle_model_counts.csv
                
# # QC 06: check A&E visits:

  qc_06_a_and_e_visits:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/qc06_check_ane_distribution_models.R
    outputs: 
      moderately_sensitive: 
        ane_distribution: output/qc06_ane_distribution_compare.png
        ane_overdispersion: output/qc06_ane_vist_overdispersion_test.csv
        ane_model_comparison: output/qc06_ane_vist_model_compare.csv
        
        
# # OPA visits - hurdle
        
  report_03_hurdle_05_opa_visits:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st03_05_model09_opa_hurdel.R
    outputs: 
      moderately_sensitive: 
        opa_binomial: output/st03_05_opa_binomial.csv
        opa_hurdle: output/st03_05_opa_hurdle.csv
        opa_reg_summary: output/st03_05_opa_reg_summary.txt
        predicted_opa_visits: output/st03_05_opa_predicted_counts.csv
        opa_visit_bi_model_count: output/st03_05_opa_binomial_model_counts.csv
        opa_visit_hurdle_model_count: output/st03_05_opa_hurdle_model_counts.csv
                
# # QC07: check over dispersion of the rest outcomes:

  qc_07_check_over_dispersion:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/qc07_check_dispersion.R
    outputs: 
      moderately_sensitive: 
        total_visit_dispersion: output/qc07_total_vist_overdispersion_test.csv
        gp_visit_dispersion: output/qc07_gp_vist_overdispersion_test.csv
        opa_visit_dispersion: output/qc07_opa_vist_overdispersion_test.csv

# # Visulize outcomes:

  visualise_visit_outcomes:
    needs: [report_03_hurdle_01_all_visits, report_03_hurdle_02_gp_visits, report_03_hurdle_03_hospital_admin, report_03_hurdle_04_ane_visits,report_03_hurdle_05_opa_visits]
    run: 
      r:latest analysis/st03_visualise_outcomes.R
    outputs: 
      moderately_sensitive: 
        outcomes_plots: output/st03_healthcare_visits.png



# # Subgroup analyses 1: factors associated with high healthcare use among LC
  report_sub_lc_only_factors:  
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st03_05_subgroup_lc_only_factors.R
    outputs: 
      moderately_sensitive:
        all_factors_bi_or: output/st03_05_sub_all_factors_binomial.csv
        all_factors_hurdle_rr: output/st03_05_sub_all_factors_hurdle.csv
        lc_only_reg_summary: output/st03_05_subgroup_lc_only_reg_summary.txt
        lc_only_bi_visits: output/st03_05_sub_lc_only_binomial.csv
        lc_only_hurdle_visits: output/st03_05_sub_lc_only_hurdle.csv
        nolc_bi_or: output/st03_05_sub_nolc_binomial.csv
        nolc_hurdle_rr: output/st03_05_sub_nolc_hurdle.csv
        sub_predicted_visits_lc_nolc_all: output/st03_05_sub_predicted_visits.csv
        sub_all_lc_no_model_count: output/st03_05_sub_groups_bi_model_counts.csv
        sub_all_lc_no_hurdle_count: output/st03_05_sub_lc_only_hurdle_model_counts.csv        
        
# # visualise subgroup lc only outputs:
  visualise_sub_lc_only_factors:  
    needs: [report_sub_lc_only_factors]
    run: 
      r:latest analysis/st03_sub_visualise_lc_factors.R
    outputs: 
      moderately_sensitive:
        lc_only_forest_plot: output/st03_sub_lc_factors.png

# # QC step: check lc only analysis model assumption
  qc_08_lc_only_factors:  
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/qc08_subgroup_lconly_check_dispersion.R
    outputs: 
      moderately_sensitive:
        lc_only_model_check: output/qc08_lc_only_overdispersion_test.csv

# # Subgroup all visits by hospitalisation, sex, age - hurdle
  report_03_hurdle_05_subgroup_visits:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st03_05_subgroups_model_hurdle.R
    outputs: 
      moderately_sensitive: 
        previous_hospitalisation_stratum: output/st03_05_subgroup_hospitalisation.csv
        sex_stratum: output/st03_05_subgroup_sex.csv
        age_cat_stratum: output/st03_05_subgroup_age.csv
        predict_subgoups_visits: output/st03_05_subgroup_predicted_value.csv

# Total Costs: twopart model

  report_04_total_costs_twopart:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st04_01_total_cost_twopart.R
    outputs: 
      moderately_sensitive: 
        binary_total_cost: output/st04_01_total_cost_binary.csv
        tpm_total_cost: output/st04_01_total_cost_gammaglm.csv
        total_cost_tpm_summary: output/st04_01_total_reg_summary.txt
        predicted_total_costs: output/st04_01_total_cost_predicted_costs.csv
        total_cost_bi_model_check: output/st04_01_total_binomial_model_counts.csv
        total_cost_gamma_model_check: output/st04_01_total_gamma_model_counts.csv

#  GP costs: run two part model and predict costs
  report_04_02_predict_gp_cost_twopm:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st04_02_predict_gp_cost_twopart.R
    outputs: 
      moderately_sensitive: 
        gp_cost-binomial: output/st04_02_gp_cost_binomial_output.csv
        gp_cost_twopm: output/st04_02_gp_cost_twopm_output.csv
        gp_cost_tpm_reg_summary: output/st04_02_gp_reg_summary.txt
        gp_predicted_costs: output/st04_02_predict_gp_cost_tpm.csv
        gp_cost_bi_model_check: output/st04_02_gp_binomial_model_counts.csv
        gp_cost_gamma_model_check: output/st04_02_gp_gamma_model_counts.csv


# APC costs: run two part model and predict costs
  report_04_03_predict_apc_cost_twopm:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st04_03_predict_apc_cost_twopart.R
    outputs: 
      moderately_sensitive: 
        apc_cost_binomial: output/st04_03_apc_cost_binomial_output.csv
        apc_cost_twopm: output/st04_03_apc_cost_twopm_output.csv
        apc_cost_reg_summary: output/st04_03_apc_cost_reg_summary.txt
        apc_predicted_costs: output/st04_03_predict_apc_cost_tpm.csv
        apc_cost_bi_model_check: output/st04_03_apc_binomial_model_counts.csv
        apc_cost_gamma_model_check: output/st04_03_apc_gamma_model_counts.csv

# A&E costs: run two part model and predict costs
  report_04_04_predict_ane_cost_twopm:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st04_04_predict_ane_cost_twopart.R
    outputs: 
      moderately_sensitive: 
        ane_cost_binomial: output/st04_04_ane_cost_binomial_output.csv
        ane_cost_twopm: output/st04_04_ane_cost_twopm_output.csv
        ane_cost_reg_summary: output/st04_04_ane_reg_summary.txt
        ane_predicted_costs: output/st04_04_predict_ane_cost_tpm.csv
        ane_cost_bi_model_check: output/st04_04_ane_binomial_model_counts.csv
        ane_cost_gamma_model_check: output/st04_04_ane_gamma_model_counts.csv

# OPA costs: run two part model and predict costs
  report_04_05_predict_opa_cost_twopm:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st04_05_predict_opa_cost_twopart.R
    outputs: 
      moderately_sensitive: 
        opa_cost_binomial: output/st04_05_opa_cost_binomial_output.csv
        opa_cost_twopm: output/st04_05_opa_cost_twopm_output.csv
        opa_cost_reg_summary: output/st04_05_opa_reg_summary.txt
        opa_predicted_costs: output/st04_05_predict_opa_cost_tpm.csv
        opa_cost_bi_model_check: output/st04_05_opa_binomial_model_counts.csv
        opa_cost_gamma_model_check: output/st04_05_opa_gamma_model_counts.csv

# # Visulize outcomes:

  visualise_cost_outcomes:
    needs: [report_04_total_costs_twopart, report_04_02_predict_gp_cost_twopm, report_04_03_predict_apc_cost_twopm, report_04_04_predict_ane_cost_twopm, report_04_05_predict_opa_cost_twopm]
    run: 
      r:latest analysis/st04_visualise_cost_outcomes.R
    outputs: 
      moderately_sensitive: 
        outcomes_plots: output/st04_healthcare_costs.png


# Historical: data distribution
  report05_hx_matched_data_distribution:
    needs: [import_matched_historical_exposure, import_matched_historical_controls]
    run: 
      r:latest analysis/st05_report_matched_historical_records.R
    outputs: 
      moderately_sensitive: 
        historical_table_1: output/st05_hx_matched_numbers_table.csv
        crude_visits_distribution: output/st05_hx_crude_vistis_exp_time.csv
        hx_now_smooth_line: output/st05_smooth_comparison.jpg

# # Historical: difference-in-difference model with two-part model

  report_05_did_tpm_model:      
    needs: [import_matched_historical_exposure, import_matched_historical_controls]
    run: 
      r:latest analysis/st05_did_twopart.R
    outputs: 
      moderately_sensitive: 
        did_crude_plot: output/st05_did_crude.png
        did_adj_plot: output/st05_did_adj.png
        did_reg_table: output/st05_did_tpm_predicted.csv
        did_reg_summary: output/st05_did_reg_summary_output.txt

# Supplementary materials

  report_sup_exploring_outcome_dist:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st_sup_01_data_exploration.R
    outputs: 
      moderately_sensitive: 
        zero_percent_fig: output/st_sup_1_5_explore_zero_percentage.png
        monthly_oucome_tb: output/st_sup_1_5_monthly_outcome_distribution.csv
        visit_explore: output/st_sup_1_5_cat_visits_summary.csv
        
  report_sup_model_selection:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st_sup_01_model_selection.R
    outputs: 
      moderately_sensitive: 
        model_01_poisson: output/st_sup_model_selection.csv