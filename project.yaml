version: '3.0'

expectations:
  population_size: 5000

actions:
# Contemporary comparison data management:
# # Before matching data management:
  generate_long_covid_exposure_dataset:
    run: 
      databuilder:v0 generate-dataset
        analysis/dataset_definition_unmatched_exp_lc.py
        --output output/dataset_exp_lc_unmatched.csv
    outputs:
      highly_sensitive:
        cohort: output/dataset_exp_lc_unmatched.csv

  generate_list_gp_use_long_covid_dx:
    run: 
      databuilder:v0 generate-dataset
        analysis/dataset_definition_lc_gp_list.py
        --output output/dataset_lc_gp_list.csv
    outputs:
      highly_sensitive:
        cohort: output/dataset_lc_gp_list.csv

  generate_dataset_comparator_exclude_gp_no_long_covid:
    needs: [generate_list_gp_use_long_covid_dx]
    run: 
      databuilder:v0 generate-dataset
        analysis/dataset_definition_unmatched_comparator.py
        --output output/dataset_comparator_unmatched.csv
    outputs:
      highly_sensitive:
        cohort: output/dataset_comparator_unmatched.csv

# # OS matching
  test_matching:
    run:
      python:latest python analysis/match_test.py
    needs: [generate_dataset_comparator_exclude_gp_no_long_covid, generate_long_covid_exposure_dataset]
    outputs: 
      highly_sensitive:
        matched_cases: output/matched_cases_stp.csv
        matched_matches: output/matched_matches_stp.csv
        matched_all: output/matched_combined_stp.csv
      moderately_sensitive: 
        matching_report: output/matching_report_stp.txt
# # After matching data management
  import_matched_exposure:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_cases.py
        --output output/matched_cases_with_ehr.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_cases_with_ehr.csv.gz

  import_matched_controls:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_control.py
        --output output/matched_control_with_ehr.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_control_with_ehr.csv.gz


  import_matched_exposure_drug_cost:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_cases_drug_costs.py
        --output output/matched_cases_with_drug_costs.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_cases_with_drug_costs.csv.gz

  import_matched_controls_drug_costs:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_control_drug_costs.py
        --output output/matched_control_with_drug_costs.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_control_with_drug_costs.csv.gz

# # After matching data management: for new version of data
  import_matched_exposure_update:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_cases_updated.py
        --output output/matched_cases_with_ehr_update.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_cases_with_ehr_update.csv.gz

  import_matched_control_updates:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_matched_control_updated.py
        --output output/matched_control_with_ehr_update.csv.gz
    needs: [test_matching]
    outputs: 
      highly_sensitive:
        cohort: output/matched_control_with_ehr_update.csv.gz

# Historical comparison data management:
# # Before matching data management:
  generate_historical_exp_data:
    run: 
      databuilder:v0 generate-dataset analysis/dataset_definition_hx_unmatched_exp_lc.py
        --output output/hx_unmatched_exp.csv
    outputs:
      highly_sensitive:
        hx_cohort: output/hx_unmatched_exp.csv
  
  generate_historical_comp_data_exclude_gp_no_long_covid:
    needs: [generate_list_gp_use_long_covid_dx]
    run: 
      databuilder:v0 generate-dataset analysis/dataset_definition_hx_unmatched_com_no_lc.py
        --output output/hx_dataset_comp_unmatched.csv
    outputs:
      highly_sensitive:
        hx_cohort: output/hx_dataset_comp_unmatched.csv

# # OS matching
  historical_matching:
    run:
      python:latest python analysis/match_historical.py
    needs: [generate_historical_exp_data, generate_historical_comp_data_exclude_gp_no_long_covid]
    outputs: 
      highly_sensitive:
        matched_cases: output/matched_cases_historical.csv
        matched_matches: output/matched_matches_historical.csv
        matched_all: output/matched_combined_historical.csv
      moderately_sensitive: 
        matching_report: output/matching_report_historical.txt

# # After matching data management
  import_matched_historical_exposure:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_hx_matched_exp_lc.py
        --output output/hx_matched_cases_with_ehr.csv.gz
    needs: [historical_matching]
    outputs: 
      highly_sensitive:
        cohort: output/hx_matched_cases_with_ehr.csv.gz

  import_matched_historical_controls:
    run: 
       databuilder:v0
        generate-dataset analysis/dataset_definition_hx_matched_comp.py
        --output output/hx_matched_control_with_ehr.csv.gz
    needs: [historical_matching]
    outputs: 
      highly_sensitive:
        cohort: output/hx_matched_control_with_ehr.csv.gz

# Reporting: demographic distribution 

# Contemporary comparison: 
  report01_matched_datasets:
    needs: [import_matched_exposure_update, import_matched_control_updates, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st01_report_matched.R
    outputs: 
      moderately_sensitive: 
        matched_table: output/st01_matched_numbers_table.csv  # Table 1
        explore_fu_time: output/st01_matched_numbers_check_fu.csv # check the incorrect follow-up time
        explore_vax_fig: output/st1_exporing_vax_index_date.png # Check vax date
        missing_table: output/missing_distribution_table.csv # Missing pattern tab
        missing_pattern: output/missing_pattern_current.png # Missing patter plot

# Contemporary comparison

# Two part hurdle model:
# # Main results: all healthcare utilisation 

  report_02_01_all_visits_hurdle:
    needs: [import_matched_exposure_update, import_matched_control_updates, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st02_01_now_total_visit_hurdel.R
    outputs: 
      moderately_sensitive:
        total_reg_summary: output/st02_01_total_reg_summary.txt
        binomial_visits: output/st02_01_total_binomial.csv
        hurdle_all_visits: output/st02_01_total_hurdle.csv
        predicted_visits: output/st02_01_total_predicted_counts.csv
        total_visit_bi_model_count: output/st02_01_total_binomial_model_counts.csv
        total_visit_hurdle_count: output/st02_01_total_hurdle_model_counts.csv

# # Visulize main outcome:

  report_02_06_plot_main_visit_outcomes:
    needs: [report_02_01_all_visits_hurdle]
    run:
      r:latest analysis/st02_06_visualise_total_outcome.R
    outputs:
      moderately_sensitive:
        outcomes_plots: output/st02_06_total_healthcare_visits.png


# # Total primary care utilisation  - hurdle

  report_02_02_primary_care_visit_hurdle:
    needs: [import_matched_exposure_update, import_matched_control_updates, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st02_02_now_primarycare_visits_hurdel.R
    outputs: 
      moderately_sensitive: 
        gp_reg_summary: output/st02_02_gp_reg_summary.txt
        gp_binomial: output/st02_02_gp_binomial.csv
        gp_hurdle: output/st02_02_gp_hurdle.csv
        predicted_gp_visits: output/st02_02_gp_predicted_counts.csv
        gp_visit_bi_model_count: output/st02_02_gp_binomial_model_counts.csv
        gp_visit_hurdle_model_count: output/st02_02_gp_hurdle_model_counts.csv

# # Hospital admission - hurdle

  report_02_03_now_hospital_admin_hurdle:
    needs: [import_matched_exposure_update, import_matched_control_updates, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st02_03_now_hospital_hurdel.R
    outputs: 
      moderately_sensitive: 
        hos_binomial: output/st02_03_hos_binomial.csv
        hos_hurdle: output/st02_03_hos_hurdle.csv
        hos_reg_summary: output/st02_03_hos_reg_summary.txt
        predicted_hos_admin_counts: output/st02_03_hos_predicted_counts.csv
        hos_visit_bi_model_count: output/st02_03_hos_binomial_model_counts.csv
        hos_visit_hurdle_model_count: output/st02_03_hos_hurdle_model_counts.csv

        
# # A&E visits - hurdle
        
  report_02_04_now_ane_visits_hurdle:
    needs: [import_matched_exposure_update, import_matched_control_updates, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st02_04_now_ane_visits_hurdel.R
    outputs: 
      moderately_sensitive: 
        ane_binomial: output/st02_04_ane_binomial.csv
        ane_hurdle: output/st02_04_ane_hurdle.csv
        ane_reg_summary: output/st02_04_ane_reg_summary.txt
        predicted_ane_visits: output/st02_04_ane_predicted_counts.csv
        ane_visit_bi_model_count: output/st02_04_ane_binomial_model_counts.csv
        ane_visit_hurdle_model_count: output/st02_04_ane_hurdle_model_counts.csv    
        
# # OPA visits - hurdle
  report_02_05_now_opa_visits_hurdle:
    needs: [import_matched_exposure_update, import_matched_control_updates, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st02_05_now_opa_visits_hurdel.R
    outputs: 
      moderately_sensitive: 
        opa_binomial: output/st02_05_opa_binomial.csv
        opa_hurdle: output/st02_05_opa_hurdle.csv
        opa_reg_summary: output/st02_05_opa_reg_summary.txt
        predicted_opa_visits: output/st02_05_opa_predicted_counts.csv
        opa_visit_bi_model_count: output/st02_05_opa_binomial_model_counts.csv
        opa_visit_hurdle_model_count: output/st02_05_opa_hurdle_model_counts.csv

# # Visulize different type of outcomes:

  report_02_07_plot_different_type_outcomes:
    needs: [report_02_02_primary_care_visit_hurdle, report_02_03_now_hospital_admin_hurdle, report_02_04_now_ane_visits_hurdle, report_02_05_now_opa_visits_hurdle]
    run:
      r:latest analysis/st02_07_visualise_outcomes_by_types.R
    outputs:
      moderately_sensitive:
        primary_care_plots: output/st02_07_parimary_care_visits.png
        hos_admin_plots: output/st02_07_hospitalisations.png
        a_and_e_visit_plots: output/st02_07_a_and_e_visits.png
        opa_visit_plots: output/st02_07_opa_visits.png


# Main outcome: total Costs using twopart model

  report_03_03_total_costs_twopart:
    needs: [import_matched_exposure_update, import_matched_control_updates, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st03_03_now_total_cost_twopart.R
    outputs: 
      moderately_sensitive:
        total_cost_reg_summary: output/st03_03_total_reg_summary.txt
        total_cost_binary: output/st03_03_total_cost_binary.csv
        total_cost_tpm: output/st03_03_total_cost_gammaglm.csv
        predicted_total_costs: output/st03_03_total_cost_predicted_costs.csv
        total_cost_bi_model_check: output/st03_03_total_cost_binomial_model_counts.csv
        total_cost_gamma_model_check: output/st03_03_total_cost_gamma_model_counts.csv

# # Visulize main cost outcome:

  report_03_08_plot_main_cost_outcomes:
    needs: [report_03_03_total_costs_twopart]
    run:
      r:latest analysis/st03_08_visualise_total_cost_outcomes.R
    outputs:
      moderately_sensitive:
        total_cost_outcomes_plots: output/st03_08_total_cost.png



#  GP costs: run two part model and predict costs
  report_03_04_gp_cost_twopm:
    needs: [import_matched_exposure_update, import_matched_control_updates, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st03_04_now_gp_cost_twopart.R
    outputs: 
      moderately_sensitive: 
        gp_cost-binomial: output/st03_04_now_gp_cost_binomial_output.csv
        gp_cost_twopm: output/st03_04_now_gp_cost_twopm_output.csv
        gp_cost_tpm_reg_summary: output/st03_04_now_gp_reg_summary.txt
        gp_predicted_costs: output/st03_04_predict_gp_cost_tpm.csv
        gp_cost_bi_model_check: output/st03_04_gp_binomial_model_counts.csv
        gp_cost_gamma_model_check: output/st03_04_gp_gamma_model_counts.csv


# APC costs: run two part model and predict costs
  report_04_03_predict_apc_cost_twopm:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st04_03_predict_apc_cost_twopart.R
    outputs: 
      moderately_sensitive: 
        apc_cost_binomial: output/st04_03_apc_cost_binomial_output.csv
        apc_cost_twopm: output/st04_03_apc_cost_twopm_output.csv
        apc_cost_reg_summary: output/st04_03_apc_cost_reg_summary.txt
        apc_predicted_costs: output/st04_03_predict_apc_cost_tpm.csv
        apc_cost_bi_model_check: output/st04_03_apc_binomial_model_counts.csv
        apc_cost_gamma_model_check: output/st04_03_apc_gamma_model_counts.csv

# A&E costs: run two part model and predict costs
  report_04_04_predict_ane_cost_twopm:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st04_04_predict_ane_cost_twopart.R
    outputs: 
      moderately_sensitive: 
        ane_cost_binomial: output/st04_04_ane_cost_binomial_output.csv
        ane_cost_twopm: output/st04_04_ane_cost_twopm_output.csv
        ane_cost_reg_summary: output/st04_04_ane_reg_summary.txt
        ane_predicted_costs: output/st04_04_predict_ane_cost_tpm.csv
        ane_cost_bi_model_check: output/st04_04_ane_binomial_model_counts.csv
        ane_cost_gamma_model_check: output/st04_04_ane_gamma_model_counts.csv

# OPA costs: run two part model and predict costs
  report_04_05_predict_opa_cost_twopm:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/st04_05_predict_opa_cost_twopart.R
    outputs: 
      moderately_sensitive: 
        opa_cost_binomial: output/st04_05_opa_cost_binomial_output.csv
        opa_cost_twopm: output/st04_05_opa_cost_twopm_output.csv
        opa_cost_reg_summary: output/st04_05_opa_reg_summary.txt
        opa_predicted_costs: output/st04_05_predict_opa_cost_tpm.csv
        opa_cost_bi_model_check: output/st04_05_opa_binomial_model_counts.csv
        opa_cost_gamma_model_check: output/st04_05_opa_gamma_model_counts.csv

# # Visulize outcomes:

  # visualise_cost_outcomes:
  #   needs: [report_04_total_costs_twopart, report_04_02_predict_gp_cost_twopm, report_04_03_predict_apc_cost_twopm, report_04_04_predict_ane_cost_twopm, report_04_05_predict_opa_cost_twopm]
  #   run: 
  #     r:latest analysis/st04_visualise_cost_outcomes.R
  #   outputs: 
  #     moderately_sensitive: 
  #       outcomes_plots: output/st04_healthcare_costs.png


# Historical: data distribution
  report05_hx_matched_data_distribution:
    needs: [import_matched_historical_exposure, import_matched_historical_controls]
    run: 
      r:latest analysis/st05_report_matched_historical_records.R
    outputs: 
      moderately_sensitive: 
        historical_table_1: output/st05_hx_matched_numbers_table.csv
        crude_visits_distribution: output/st05_hx_crude_vistis_exp_time.csv
        hx_now_smooth_line: output/st05_smooth_comparison.jpg

# # Historical: difference-in-difference model with two-part model

  report_05_did_tpm_model:      
    needs: [import_matched_historical_exposure, import_matched_historical_controls]
    run: 
      r:latest analysis/st05_did_twopart.R
    outputs: 
      moderately_sensitive: 
        did_crude_plot: output/st05_did_crude.png
        did_adj_plot: output/st05_did_adj.png
        did_reg_table: output/st05_did_tpm_predicted.csv
        did_reg_summary: output/st05_did_reg_summary_output.txt




# # Subgroup analyses 1: factors associated with high healthcare use among LC
  report_sub_lc_only_factors:  
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st03_05_subgroup_lc_only_factors.R
    outputs: 
      moderately_sensitive:
        all_factors_bi_or: output/st03_05_sub_all_factors_binomial.csv
        all_factors_hurdle_rr: output/st03_05_sub_all_factors_hurdle.csv
        lc_only_reg_summary: output/st03_05_subgroup_lc_only_reg_summary.txt
        lc_only_bi_visits: output/st03_05_sub_lc_only_binomial.csv
        lc_only_hurdle_visits: output/st03_05_sub_lc_only_hurdle.csv
        nolc_bi_or: output/st03_05_sub_nolc_binomial.csv
        nolc_hurdle_rr: output/st03_05_sub_nolc_hurdle.csv
        sub_predicted_visits_lc_nolc_all: output/st03_05_sub_predicted_visits.csv
        sub_all_lc_no_model_count: output/st03_05_sub_groups_bi_model_counts.csv
        sub_all_lc_no_hurdle_count: output/st03_05_sub_lc_only_hurdle_model_counts.csv        
        
# # visualise subgroup lc only outputs:
  visualise_sub_lc_only_factors:  
    needs: [report_sub_lc_only_factors]
    run: 
      r:latest analysis/st03_sub_visualise_lc_factors.R
    outputs: 
      moderately_sensitive:
        all_factor_forest_plot: output/st03_sub_all_factors.png
        lc_only_forest_plot: output/st03_sub_lc_factors.png
        nolc_forest_plot: output/st03_sub_nolc_factors.png
        predicted_subgroups_visits: output/st03_sub_all_lc_nolc_predicted_visits.png


# # Stratified by hospitalisation, sex, age - hurdle
  report_03_hurdle_05_subgroup_visits:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st03_05_subgroups_model_hurdle.R
    outputs: 
      moderately_sensitive: 
        previous_hospitalisation_stratum: output/st03_05_subgroup_hospitalisation.csv
        sex_stratum: output/st03_05_subgroup_sex.csv
        age_cat_stratum: output/st03_05_subgroup_age.csv
        predict_subgoups_visits: output/st03_05_subgroup_predicted_value.csv

# # Visualise the stratum specific outcomes:
  report_03_05_stratification_results:
    needs: [report_03_hurdle_05_subgroup_visits]
    run: 
      r:latest analysis/st03_05_visualise_stratum.R
    outputs: 
      moderately_sensitive: 
        hospital_stratum_results: output/st03_05_stratum_hos_visits.png
        sex_stratum_results: output/st03_05_stratum_sex_visits.png
        age_cat_stratum_results: output/st03_05_stratum_age_visits.png

# Supplementary materials

  report_sup_exploring_outcome_dist:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st_sup_01_data_exploration.R
    outputs: 
      moderately_sensitive: 
        zero_percent_fig: output/st_sup_1_5_explore_zero_percentage.png
        monthly_oucome_tb: output/st_sup_1_5_monthly_outcome_distribution.csv
        visit_explore: output/st_sup_1_5_cat_visits_summary.csv
        
  report_sup_model_selection:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/st_sup_01_model_selection.R
    outputs: 
      moderately_sensitive: 
        model_01_poisson: output/st_sup_model_selection.csv

# QC steps: -----------
        
# # # QC step:         
  qc_01examine_unmatched_data:
    needs: [generate_dataset_comparator_exclude_gp_no_long_covid, generate_long_covid_exposure_dataset]  
    run: 
      r:latest analysis/qc01_unmatched_control.R
    outputs:
      moderately_sensitive:
        cohort: output/qc01_check_unmatched.csv
        
# # # QC step:         
  qc_02examine_historical_unmatched_data:
    needs: [generate_historical_exp_data, generate_historical_comp_data_exclude_gp_no_long_covid]  
    run: 
      r:latest analysis/qc02_hx_unmatched_check.R
    outputs:
      moderately_sensitive:
        cohort: output/qc02_hx_check_unmatched.csv

        
# # QC 05: check hospital admission distribution:

  qc_05_h_hospital_admin:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/qc05_check_hos_distribution_models.R
    outputs: 
      moderately_sensitive: 
        hos_distribution: output/qc05_hos_distribution_compare.png
        hos_overdispersion: output/qc05_hos_vist_overdispersion_test.csv
        hos_model_comparison: output/qc05_hos_vist_model_compare.csv

# Check follow-up time 
  qc_03_check_na:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/qc03_now_check_followup.R
    outputs: 
      moderately_sensitive: 
        check_na_in_data: output/st02_check_min.csv
                
# # QC 06: check A&E visits:

  qc_06_a_and_e_visits:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/qc06_check_ane_distribution_models.R
    outputs: 
      moderately_sensitive: 
        ane_distribution: output/qc06_ane_distribution_compare.png
        ane_overdispersion: output/qc06_ane_vist_overdispersion_test.csv
        ane_model_comparison: output/qc06_ane_vist_model_compare.csv        
                
# # QC07: check over dispersion of the rest outcomes:

  qc_07_check_over_dispersion:
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/qc07_check_dispersion.R
    outputs: 
      moderately_sensitive: 
        total_visit_dispersion: output/qc07_total_vist_overdispersion_test.csv
        gp_visit_dispersion: output/qc07_gp_vist_overdispersion_test.csv
        opa_visit_dispersion: output/qc07_opa_vist_overdispersion_test.csv

# # QC step: check lc only analysis model assumption
  qc_08_lc_only_factors:  
    needs: [import_matched_exposure, import_matched_controls]
    run: 
      r:latest analysis/qc08_subgroup_lconly_check_dispersion.R
    outputs: 
      moderately_sensitive:
        lc_only_model_check: output/qc08_lc_only_overdispersion_test.csv
        
# QC09: check the inconsistent pairs between visits and costs data:

  qc09_visit_cost_inconsistence:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/qc09_compare_non_zero_prob_visit_cost.R
    outputs: 
      moderately_sensitive: 
        total_inconsistence: output/qc09_total_inconsistent_visit_cost.csv
        total_inconcsistence_trend_month: output/qc09_non_zero_counts_comparison.png
        gp_inconsistence: output/qc09_gp_inconsistent_visit_cost.csv
        gp_inconsistence_monthly_trend: output/qc09_gp_non_zero_counts_comparison.png
        hos_inconsistence: output/qc09_hos_inconsistent_visit_cost.csv
        hos_inconsistence_trend: output/qc09_hos_non_zero_counts_comparison.png
        ae_inconsistence: output/qc09_ae_inconsistent_visit_cost.csv
        ae_inconsistence_monthly: output/qc09_ae_non_zero_counts_comparison.png
        opa_inconsistence: output/qc09_opa_inconsistent_visit_cost.csv
        opa_inconsistence_monthly: output/qc09_opa_non_zero_counts_comparison.png

# check distribution using the new dataset
  qc09_visit_cost_inconsistence_new_dataset:
    needs: [import_matched_exposure_update, import_matched_control_updates, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/new_qc09_compare_non_zero_prob_visit_cost.R
    outputs: 
      moderately_sensitive: 
        total_inconsistence: output/new_qc09_total_inconsistent_visit_cost.csv
        total_inconcsistence_trend_month: output/new_qc09_non_zero_counts_comparison.png
        gp_inconsistence: output/new_qc09_gp_inconsistent_visit_cost.csv
        gp_inconsistence_monthly_trend: output/new_qc09_gp_non_zero_counts_comparison.png
        hos_inconsistence: output/new_qc09_hos_inconsistent_visit_cost.csv
        hos_inconsistence_trend: output/new_qc09_hos_non_zero_counts_comparison.png
        ae_inconsistence: output/new_qc09_ae_inconsistent_visit_cost.csv
        ae_inconsistence_monthly: output/new_qc09_ae_non_zero_counts_comparison.png
        opa_inconsistence: output/new_qc09_opa_inconsistent_visit_cost.csv
        opa_inconsistence_monthly: output/new_qc09_opa_non_zero_counts_comparison.png        

# QC10: check cost data disribution

  qc10_cost_distribution:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/qc10_cost_data_check.R
    outputs: 
      moderately_sensitive: 
        gp_cost_distribution: output/qc10_gp_cost_distribution.csv
        hos_cost_distribution: output/qc10_hos_cost_distribution.csv
        ane_cost_distribution: output/qc10_ane_cost_distribution.csv
        opa_cost_distribution: output/qc10_opa_cost_distribution.csv
        
  qc10_cost_distribution_new_data:
    needs: [import_matched_exposure_update, import_matched_control_updates, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/new_qc10_cost_data_check.R
    outputs: 
      moderately_sensitive: 
        gp_cost_distribution: output/new_qc10_gp_cost_distribution.csv
        hos_cost_distribution: output/new_qc10_hos_cost_distribution.csv
        ane_cost_distribution: output/new_qc10_ane_cost_distribution.csv
        opa_cost_distribution: output/new_qc10_opa_cost_distribution.csv

# QC: check unit costs:
  qc13_existing_unit_cost:
    needs: [import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/qc14_estimate_existing_unit_costs.R
    outputs: 
      moderately_sensitive: 
        hos_unit_cost: output/st04_apc_unit_costs.csv
        opa_unit_cost: output/st04_opa_unit_costs.csv
        ane_unit_cost: output/st04_ane_unit_costs.csv
        
  qc13_new_unit_cost:
    needs: [import_matched_exposure_update, import_matched_control_updates,import_matched_exposure, import_matched_controls, import_matched_exposure_drug_cost, import_matched_controls_drug_costs]
    run: 
      r:latest analysis/qc14_estimate_new_unit_costs.R
    outputs: 
      moderately_sensitive: 
        hos_new_unit_cost: output/st04_apc_new_unit_costs.csv
        opa_new_unit_cost: output/st04_opa_new_unit_costs.csv
        ane_new_unit_cost: output/st04_ane_new_unit_costs.csv        